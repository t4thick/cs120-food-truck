{% extends "base.html" %}
{% block content %}

<!-- Flatpickr for Date Picker -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/themes/material_red.css">
<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>

<style>
/* ========== BOOKING PAGE STYLES ========== */
.booking-container {
    max-width: 900px;
    margin: 0 auto;
}

.booking-header {
    text-align: center;
    margin-bottom: 40px;
}

.booking-header h1 {
    font-size: 32px;
    margin-bottom: 8px;
    color: #1a1a1a;
}

.booking-header p {
    color: #666;
    font-size: 16px;
}

/* Progress Steps */
.booking-progress {
    display: flex;
    justify-content: center;
    gap: 8px;
    margin-bottom: 40px;
}

.progress-step {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 10px 20px;
    background: #f5f5f5;
    border-radius: 25px;
    font-size: 14px;
    color: #999;
    transition: all 0.3s ease;
}

.progress-step.active {
    background: #d6001c;
    color: white;
}

.progress-step.completed {
    background: #2e7d32;
    color: white;
}

.progress-step .step-number {
    width: 24px;
    height: 24px;
    border-radius: 50%;
    background: rgba(255,255,255,0.3);
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: 700;
    font-size: 12px;
}

.progress-step.active .step-number,
.progress-step.completed .step-number {
    background: rgba(255,255,255,0.3);
}

/* Booking Steps Content */
.booking-step {
    display: none;
    animation: fadeIn 0.4s ease;
}

.booking-step.active {
    display: block;
}

@keyframes fadeIn {
    from { opacity: 0; transform: translateY(20px); }
    to { opacity: 1; transform: translateY(0); }
}

.step-title {
    font-size: 24px;
    font-weight: 700;
    margin-bottom: 8px;
    color: #1a1a1a;
}

.step-subtitle {
    color: #666;
    margin-bottom: 24px;
    font-size: 15px;
}

/* Staff Selection Grid */
.staff-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
    gap: 16px;
    margin-bottom: 24px;
}

.staff-card {
    background: white;
    border: 2px solid #e5e5e5;
    border-radius: 16px;
    padding: 20px;
    cursor: pointer;
    transition: all 0.3s ease;
    text-align: center;
}

.staff-card:hover {
    border-color: #d6001c;
    transform: translateY(-4px);
    box-shadow: 0 8px 24px rgba(214, 0, 28, 0.15);
}

.staff-card.selected {
    border-color: #d6001c;
    background: #fff5f5;
}

.staff-avatar {
    width: 64px;
    height: 64px;
    border-radius: 50%;
    background: linear-gradient(135deg, #d6001c, #ff6b6b);
    color: white;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 24px;
    font-weight: 700;
    margin: 0 auto 12px;
}

.staff-name {
    font-size: 16px;
    font-weight: 600;
    color: #1a1a1a;
    margin-bottom: 4px;
}

.staff-email {
    font-size: 13px;
    color: #888;
}

.staff-card.selected::after {
    content: "‚úì";
    position: absolute;
    top: 10px;
    right: 10px;
    width: 24px;
    height: 24px;
    background: #2e7d32;
    color: white;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 14px;
}

.staff-card {
    position: relative;
}

/* Date Selection */
.date-picker-container {
    background: white;
    border-radius: 16px;
    padding: 24px;
    box-shadow: 0 4px 20px rgba(0,0,0,0.08);
    margin-bottom: 24px;
}

.date-picker-inline {
    width: 100%;
}

.flatpickr-calendar.inline {
    box-shadow: none !important;
    width: 100% !important;
    max-width: 400px;
    margin: 0 auto;
}

.flatpickr-day {
    color: #1a1a1a !important;
    font-weight: 500 !important;
}

.flatpickr-day.selected {
    background: #d6001c !important;
    border-color: #d6001c !important;
    color: white !important;
}

.flatpickr-day.today {
    border-color: #d6001c !important;
}

.flatpickr-weekday {
    color: #d6001c !important;
    font-weight: 700 !important;
}

.flatpickr-current-month .flatpickr-monthDropdown-months,
.flatpickr-current-month input.cur-year {
    font-weight: 700 !important;
    color: #1a1a1a !important;
}

.selected-date-display {
    text-align: center;
    padding: 16px;
    background: #fff5f5;
    border-radius: 12px;
    margin-top: 16px;
}

.selected-date-display .date-label {
    font-size: 13px;
    color: #888;
    margin-bottom: 4px;
}

.selected-date-display .date-value {
    font-size: 20px;
    font-weight: 700;
    color: #d6001c;
}

/* Time Slot Selection */
.shift-type-selector {
    display: flex;
    gap: 12px;
    margin-bottom: 24px;
    flex-wrap: wrap;
}

.shift-type-btn {
    flex: 1;
    min-width: 140px;
    padding: 16px;
    border: 2px solid #e5e5e5;
    border-radius: 12px;
    background: white;
    cursor: pointer;
    transition: all 0.3s ease;
    text-align: center;
}

.shift-type-btn:hover {
    border-color: #d6001c;
}

.shift-type-btn.selected {
    border-color: #d6001c;
    background: #fff5f5;
}

.shift-type-btn .shift-icon {
    font-size: 28px;
    margin-bottom: 8px;
}

.shift-type-btn .shift-name {
    font-weight: 600;
    color: #1a1a1a;
    margin-bottom: 4px;
}

.shift-type-btn .shift-hours {
    font-size: 13px;
    color: #888;
}

.time-slots-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
    gap: 10px;
    margin-top: 20px;
}

.time-slot {
    padding: 14px 12px;
    border: 2px solid #e5e5e5;
    border-radius: 10px;
    background: white;
    cursor: pointer;
    text-align: center;
    font-weight: 600;
    font-size: 15px;
    color: #1a1a1a;
    transition: all 0.2s ease;
}

.time-slot:hover {
    border-color: #d6001c;
    background: #fff5f5;
}

.time-slot.selected {
    border-color: #d6001c;
    background: #d6001c;
    color: white;
}

.time-slot.unavailable {
    background: #f5f5f5;
    color: #ccc;
    cursor: not-allowed;
    border-color: #eee;
}

/* Manager Input */
.manager-section {
    background: white;
    border-radius: 16px;
    padding: 24px;
    box-shadow: 0 4px 20px rgba(0,0,0,0.08);
}

.manager-input {
    width: 100%;
    padding: 14px 16px;
    border: 2px solid #e5e5e5;
    border-radius: 10px;
    font-size: 16px;
    font-family: inherit;
    transition: border-color 0.3s ease;
}

.manager-input:focus {
    outline: none;
    border-color: #d6001c;
}

/* Booking Summary */
.booking-summary {
    background: linear-gradient(135deg, #1a1a1a, #2d2d2d);
    border-radius: 20px;
    padding: 32px;
    color: white;
    margin-top: 24px;
}

.summary-title {
    font-size: 20px;
    font-weight: 700;
    margin-bottom: 24px;
    display: flex;
    align-items: center;
    gap: 10px;
}

.summary-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 20px;
    margin-bottom: 24px;
}

.summary-item {
    background: rgba(255,255,255,0.1);
    border-radius: 12px;
    padding: 16px;
}

.summary-item .label {
    font-size: 12px;
    color: rgba(255,255,255,0.6);
    text-transform: uppercase;
    letter-spacing: 0.5px;
    margin-bottom: 6px;
}

.summary-item .value {
    font-size: 16px;
    font-weight: 600;
}

.summary-item .value.highlight {
    color: #ff6b6b;
}

/* Navigation Buttons */
.booking-nav {
    display: flex;
    justify-content: space-between;
    gap: 16px;
    margin-top: 32px;
}

.nav-btn {
    padding: 14px 28px;
    border-radius: 10px;
    font-size: 15px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;
    border: none;
    font-family: inherit;
}

.nav-btn.back {
    background: #f5f5f5;
    color: #666;
}

.nav-btn.back:hover {
    background: #eee;
}

.nav-btn.next {
    background: #d6001c;
    color: white;
    margin-left: auto;
}

.nav-btn.next:hover {
    background: #b8001a;
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(214, 0, 28, 0.3);
}

.nav-btn.next:disabled {
    background: #ccc;
    cursor: not-allowed;
    transform: none;
    box-shadow: none;
}

.nav-btn.confirm {
    background: #2e7d32;
    color: white;
    width: 100%;
    padding: 18px;
    font-size: 16px;
}

.nav-btn.confirm:hover {
    background: #1b5e20;
}

/* Tips Box */
.tips-box {
    background: #fff8e1;
    border-left: 4px solid #ffc107;
    border-radius: 0 12px 12px 0;
    padding: 16px 20px;
    margin-top: 24px;
}

.tips-box h4 {
    color: #f57c00;
    margin: 0 0 8px;
    font-size: 14px;
}

.tips-box ul {
    margin: 0;
    padding-left: 18px;
    color: #666;
    font-size: 13px;
}

.tips-box li {
    margin-bottom: 4px;
}

@media (max-width: 768px) {
    .booking-progress {
        flex-wrap: wrap;
    }
    
    .progress-step {
        font-size: 12px;
        padding: 8px 12px;
    }
    
    .summary-grid {
        grid-template-columns: 1fr;
    }
    
    .staff-grid {
        grid-template-columns: 1fr;
    }
}
</style>

<div class="booking-container">
    <div class="booking-header">
        <h1>üìÖ Book Staff Schedule</h1>
        <p>Create a new work shift for your team members in just a few steps</p>
    </div>

    <!-- Progress Steps -->
    <div class="booking-progress">
        <div class="progress-step active" data-step="1">
            <span class="step-number">1</span>
            <span>Select Staff</span>
        </div>
        <div class="progress-step" data-step="2">
            <span class="step-number">2</span>
            <span>Pick Date</span>
        </div>
        <div class="progress-step" data-step="3">
            <span class="step-number">3</span>
            <span>Choose Time</span>
        </div>
        <div class="progress-step" data-step="4">
            <span class="step-number">4</span>
            <span>Confirm</span>
        </div>
    </div>

    <form action="{{ url_for('book_schedule_submit') }}" method="POST" id="bookingForm">
        <!-- Hidden inputs to store selections -->
        <input type="hidden" name="staff_email" id="staffEmailInput">
        <input type="hidden" name="date" id="dateInput">
        <input type="hidden" name="time" id="timeInput">
        <input type="hidden" name="work_time" id="workTimeInput">
        <input type="hidden" name="manager" id="managerInput">

        <!-- Step 1: Select Staff -->
        <div class="booking-step active" data-step="1">
            <h2 class="step-title">üë§ Who's working?</h2>
            <p class="step-subtitle">Select the staff member you want to schedule</p>
            
            <div class="staff-grid">
                {% for s in staff %}
                <div class="staff-card" data-email="{{ s.email }}" data-name="{{ s.first }} {{ s.last }}" onclick="selectStaff(this)">
                    <div class="staff-avatar">{{ s.first[0] }}{{ s.last[0] }}</div>
                    <div class="staff-name">{{ s.first }} {{ s.last }}</div>
                    <div class="staff-email">{{ s.email }}</div>
                </div>
                {% endfor %}
            </div>

            {% if not staff %}
            <div style="text-align: center; padding: 40px; background: #f9f9f9; border-radius: 16px;">
                <p style="font-size: 48px; margin-bottom: 16px;">üë•</p>
                <p style="color: #666;">No staff members found. Add staff first before scheduling.</p>
                <a href="{{ url_for('add_staff') }}" class="button" style="margin-top: 16px;">Add Staff Member</a>
            </div>
            {% endif %}

            <div class="booking-nav">
                <a href="{{ url_for('schedules_page') }}" class="nav-btn back">‚Üê Back to Schedules</a>
                <button type="button" class="nav-btn next" onclick="nextStep(2)" id="step1Next" disabled>Next: Pick Date ‚Üí</button>
            </div>
        </div>

        <!-- Step 2: Pick Date -->
        <div class="booking-step" data-step="2">
            <h2 class="step-title">üìÜ When?</h2>
            <p class="step-subtitle">Select the date for this shift (Tuesday - Sunday only)</p>
            
            <div class="date-picker-container">
                <div id="datePicker"></div>
                <div class="selected-date-display" id="selectedDateDisplay" style="display: none;">
                    <div class="date-label">Selected Date</div>
                    <div class="date-value" id="selectedDateText">-</div>
                </div>
            </div>

            <div class="tips-box">
                <h4>üí° Scheduling Tips</h4>
                <ul>
                    <li>The food truck operates Tuesday through Sunday</li>
                    <li>Mondays are our rest day - no shifts available</li>
                    <li>Plan at least 24 hours ahead for best coverage</li>
                </ul>
            </div>

            <div class="booking-nav">
                <button type="button" class="nav-btn back" onclick="prevStep(1)">‚Üê Back</button>
                <button type="button" class="nav-btn next" onclick="nextStep(3)" id="step2Next" disabled>Next: Choose Time ‚Üí</button>
            </div>
        </div>

        <!-- Step 3: Choose Time -->
        <div class="booking-step" data-step="3">
            <h2 class="step-title">‚è∞ What time?</h2>
            <p class="step-subtitle">Pick the shift type and start time</p>
            
            <div class="shift-type-selector">
                <div class="shift-type-btn" data-type="morning" onclick="selectShiftType(this)">
                    <div class="shift-icon">üåÖ</div>
                    <div class="shift-name">Morning</div>
                    <div class="shift-hours">9 AM - 1 PM</div>
                </div>
                <div class="shift-type-btn" data-type="afternoon" onclick="selectShiftType(this)">
                    <div class="shift-icon">‚òÄÔ∏è</div>
                    <div class="shift-name">Afternoon</div>
                    <div class="shift-hours">1 PM - 5 PM</div>
                </div>
                <div class="shift-type-btn" data-type="evening" onclick="selectShiftType(this)">
                    <div class="shift-icon">üåô</div>
                    <div class="shift-name">Evening</div>
                    <div class="shift-hours">5 PM - 9 PM</div>
                </div>
                <div class="shift-type-btn" data-type="full" onclick="selectShiftType(this)">
                    <div class="shift-icon">üí™</div>
                    <div class="shift-name">Full Day</div>
                    <div class="shift-hours">9 AM - 9 PM</div>
                </div>
            </div>

            <h3 style="margin-top: 24px; margin-bottom: 16px; font-size: 16px; color: #666;">Or select a specific start time:</h3>
            
            <div class="time-slots-grid">
                <div class="time-slot" data-time="09:00" onclick="selectTimeSlot(this)">9:00 AM</div>
                <div class="time-slot" data-time="10:00" onclick="selectTimeSlot(this)">10:00 AM</div>
                <div class="time-slot" data-time="11:00" onclick="selectTimeSlot(this)">11:00 AM</div>
                <div class="time-slot" data-time="12:00" onclick="selectTimeSlot(this)">12:00 PM</div>
                <div class="time-slot" data-time="13:00" onclick="selectTimeSlot(this)">1:00 PM</div>
                <div class="time-slot" data-time="14:00" onclick="selectTimeSlot(this)">2:00 PM</div>
                <div class="time-slot" data-time="15:00" onclick="selectTimeSlot(this)">3:00 PM</div>
                <div class="time-slot" data-time="16:00" onclick="selectTimeSlot(this)">4:00 PM</div>
                <div class="time-slot" data-time="17:00" onclick="selectTimeSlot(this)">5:00 PM</div>
                <div class="time-slot" data-time="18:00" onclick="selectTimeSlot(this)">6:00 PM</div>
                <div class="time-slot" data-time="19:00" onclick="selectTimeSlot(this)">7:00 PM</div>
                <div class="time-slot" data-time="20:00" onclick="selectTimeSlot(this)">8:00 PM</div>
            </div>

            <div class="booking-nav">
                <button type="button" class="nav-btn back" onclick="prevStep(2)">‚Üê Back</button>
                <button type="button" class="nav-btn next" onclick="nextStep(4)" id="step3Next" disabled>Next: Review ‚Üí</button>
            </div>
        </div>

        <!-- Step 4: Confirm -->
        <div class="booking-step" data-step="4">
            <h2 class="step-title">‚úÖ Review & Confirm</h2>
            <p class="step-subtitle">Make sure everything looks good before booking</p>
            
            <div class="booking-summary">
                <div class="summary-title">üìã Booking Summary</div>
                <div class="summary-grid">
                    <div class="summary-item">
                        <div class="label">Staff Member</div>
                        <div class="value" id="summaryStaff">-</div>
                    </div>
                    <div class="summary-item">
                        <div class="label">Date</div>
                        <div class="value highlight" id="summaryDate">-</div>
                    </div>
                    <div class="summary-item">
                        <div class="label">Time / Shift</div>
                        <div class="value" id="summaryTime">-</div>
                    </div>
                    <div class="summary-item">
                        <div class="label">Shift Type</div>
                        <div class="value" id="summaryShiftType">-</div>
                    </div>
                </div>
                
                <div class="manager-section" style="background: rgba(255,255,255,0.1); border-radius: 12px; padding: 16px; margin-bottom: 20px;">
                    <label style="display: block; margin-bottom: 8px; font-size: 14px; color: rgba(255,255,255,0.7);">Manager Approving This Shift</label>
                    <input type="text" class="manager-input" id="managerName" placeholder="Enter your name (manager)" required style="background: rgba(255,255,255,0.95);">
                </div>
                
                <button type="submit" class="nav-btn confirm">‚úì Confirm & Book Schedule</button>
            </div>

            <div class="booking-nav" style="margin-top: 16px;">
                <button type="button" class="nav-btn back" onclick="prevStep(3)">‚Üê Make Changes</button>
            </div>
        </div>
    </form>
</div>

<script>
// Booking state
let selectedStaff = null;
let selectedDate = null;
let selectedTime = null;
let selectedShiftType = null;
let currentStep = 1;

// Initialize date picker
document.addEventListener('DOMContentLoaded', function() {
    flatpickr("#datePicker", {
        inline: true,
        dateFormat: "Y-m-d",
        minDate: "today",
        disable: [
            function(date) {
                // Disable Mondays (day 1)
                return date.getDay() === 1;
            }
        ],
        onChange: function(selectedDates, dateStr) {
            selectedDate = dateStr;
            document.getElementById('dateInput').value = dateStr;
            
            // Format for display
            const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
            const displayDate = selectedDates[0].toLocaleDateString('en-US', options);
            document.getElementById('selectedDateText').textContent = displayDate;
            document.getElementById('selectedDateDisplay').style.display = 'block';
            document.getElementById('step2Next').disabled = false;
            
            updateProgressStep(2, true);
        }
    });
});

// Staff selection
function selectStaff(card) {
    document.querySelectorAll('.staff-card').forEach(c => c.classList.remove('selected'));
    card.classList.add('selected');
    
    selectedStaff = {
        email: card.dataset.email,
        name: card.dataset.name
    };
    
    document.getElementById('staffEmailInput').value = selectedStaff.email;
    document.getElementById('step1Next').disabled = false;
    updateProgressStep(1, true);
}

// Shift type selection
function selectShiftType(btn) {
    document.querySelectorAll('.shift-type-btn').forEach(b => b.classList.remove('selected'));
    document.querySelectorAll('.time-slot').forEach(t => t.classList.remove('selected'));
    btn.classList.add('selected');
    
    selectedShiftType = btn.dataset.type;
    
    const shiftTimes = {
        'morning': { time: '09:00', display: '9:00 AM - 1:00 PM', work: 'Morning shift 9AM-1PM' },
        'afternoon': { time: '13:00', display: '1:00 PM - 5:00 PM', work: 'Afternoon shift 1PM-5PM' },
        'evening': { time: '17:00', display: '5:00 PM - 9:00 PM', work: 'Evening shift 5PM-9PM' },
        'full': { time: '09:00', display: '9:00 AM - 9:00 PM', work: 'Full day shift 9AM-9PM' }
    };
    
    const shift = shiftTimes[selectedShiftType];
    selectedTime = shift.time;
    document.getElementById('timeInput').value = shift.time;
    document.getElementById('workTimeInput').value = shift.work;
    document.getElementById('step3Next').disabled = false;
    updateProgressStep(3, true);
}

// Time slot selection
function selectTimeSlot(slot) {
    if (slot.classList.contains('unavailable')) return;
    
    document.querySelectorAll('.time-slot').forEach(t => t.classList.remove('selected'));
    document.querySelectorAll('.shift-type-btn').forEach(b => b.classList.remove('selected'));
    slot.classList.add('selected');
    
    selectedTime = slot.dataset.time;
    selectedShiftType = 'custom';
    
    // Convert to 12-hour format for work_time
    const hour = parseInt(selectedTime.split(':')[0]);
    const ampm = hour >= 12 ? 'PM' : 'AM';
    const hour12 = hour > 12 ? hour - 12 : (hour === 0 ? 12 : hour);
    
    document.getElementById('timeInput').value = selectedTime;
    document.getElementById('workTimeInput').value = `Shift starting at ${hour12}:00 ${ampm}`;
    document.getElementById('step3Next').disabled = false;
    updateProgressStep(3, true);
}

// Navigation
function nextStep(step) {
    if (step === 4) {
        // Update summary
        document.getElementById('summaryStaff').textContent = selectedStaff ? selectedStaff.name : '-';
        
        if (selectedDate) {
            const date = new Date(selectedDate + 'T00:00:00');
            const options = { weekday: 'long', month: 'short', day: 'numeric' };
            document.getElementById('summaryDate').textContent = date.toLocaleDateString('en-US', options);
        }
        
        const timeDisplay = document.getElementById('workTimeInput').value || selectedTime;
        document.getElementById('summaryTime').textContent = timeDisplay;
        
        const shiftTypes = {
            'morning': 'üåÖ Morning Shift',
            'afternoon': '‚òÄÔ∏è Afternoon Shift',
            'evening': 'üåô Evening Shift',
            'full': 'üí™ Full Day',
            'custom': '‚è∞ Custom Time'
        };
        document.getElementById('summaryShiftType').textContent = shiftTypes[selectedShiftType] || '-';
    }
    
    showStep(step);
}

function prevStep(step) {
    showStep(step);
}

function showStep(step) {
    currentStep = step;
    
    document.querySelectorAll('.booking-step').forEach(s => s.classList.remove('active'));
    document.querySelector(`.booking-step[data-step="${step}"]`).classList.add('active');
    
    // Update progress bar
    document.querySelectorAll('.progress-step').forEach(p => {
        const pStep = parseInt(p.dataset.step);
        p.classList.remove('active', 'completed');
        if (pStep === step) {
            p.classList.add('active');
        } else if (pStep < step) {
            p.classList.add('completed');
        }
    });
    
    // Scroll to top
    window.scrollTo({ top: 0, behavior: 'smooth' });
}

function updateProgressStep(step, completed) {
    const progressStep = document.querySelector(`.progress-step[data-step="${step}"]`);
    if (completed && currentStep > step) {
        progressStep.classList.add('completed');
    }
}

// Form submission
document.getElementById('bookingForm').addEventListener('submit', function(e) {
    const managerName = document.getElementById('managerName').value.trim();
    if (!managerName) {
        e.preventDefault();
        alert('Please enter the manager name');
        return;
    }
    document.getElementById('managerInput').value = managerName;
});
</script>

{% endblock %}
